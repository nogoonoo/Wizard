
<title>Wifi</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css">
<script src="/js/nav.js"></script>
<script src="/js/util.js"></script>

<body>

<div class="content full">
  <ol class="stepper">
    <li class="active">Wi-Fi<?xml version="1.0" encoding="UTF-8"?><svg width="66px" height="66px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="#FFFFFF"><path d="M12 19.51L12.01 19.4989" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2 8C8 3.5 16 3.5 22 8" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M5 12C9 9 15 9 19 12" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M8.5 15.5C10.7504 14.1 13.2498 14.0996 15.5001 15.5" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></li>
    <li>Settings<svg xmlns="http://www.w3.org/2000/svg" width="66px" height="66px" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></li>
    <li>Finish<svg fill="#FFFFFF" height="66px" width="66px" version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 447.479 447.479" xmlns:xlink="http://www.w3.org/1999/xlink" enable-background="new 0 0 447.479 447.479" stroke="#FFFFFF"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M411.426,75.746H36.053C16.173,75.746,0,91.92,0,111.799V335.68c0,19.879,16.173,36.052,36.053,36.052h375.374 c19.879,0,36.053-16.173,36.053-36.052V111.799C447.479,91.92,431.306,75.746,411.426,75.746z M427.479,335.68 c0,8.851-7.201,16.052-16.053,16.052H36.053c-8.852,0-16.053-7.201-16.053-16.052V111.799c0-8.852,7.201-16.053,16.053-16.053 h375.374c8.852,0,16.053,7.201,16.053,16.053V335.68z"></path> <path d="m82.747,127.494c-17.506,0-31.749,14.243-31.749,31.749 0,14.011 9.127,25.923 21.745,30.125v120.615c0,5.523 4.477,10 10,10s10-4.477 10-10v-120.613c12.622-4.199 21.753-16.113 21.753-30.127-1.42109e-14-17.506-14.243-31.749-31.749-31.749zm0,43.498c-6.479,0-11.749-5.271-11.749-11.749s5.271-11.749 11.749-11.749 11.749,5.271 11.749,11.749-5.271,11.749-11.749,11.749z"></path> <path d="m186.743,172.115v-34.623c0-5.523-4.477-10-10-10s-10,4.477-10,10v34.622c-12.62,4.2-21.75,16.113-21.75,30.126s9.129,25.927 21.75,30.126v77.616c0,5.523 4.477,10 10,10s10-4.477 10-10v-77.616c12.62-4.201 21.748-16.114 21.748-30.126s-9.129-25.925-21.748-30.125zm-10.001,41.875c-6.478,0-11.749-5.271-11.749-11.749 0-6.478 5.271-11.749 11.749-11.749 6.479,0 11.749,5.271 11.749,11.749 2.84217e-14,6.478-5.271,11.749-11.749,11.749z"></path> <path d="m280.733,215.111v-77.618c0-5.523-4.477-10-10-10s-10,4.477-10,10v77.621c-12.618,4.202-21.745,16.114-21.745,30.125s9.127,25.923 21.745,30.125v34.619c0,5.523 4.477,10 10,10s10-4.477 10-10v-34.616c12.622-4.199 21.753-16.114 21.753-30.128s-9.131-25.929-21.753-30.128zm-9.996,41.877c-6.479,0-11.749-5.271-11.749-11.749s5.271-11.749 11.749-11.749c6.478,0 11.749,5.271 11.749,11.749s-5.271,11.749-11.749,11.749z"></path> <path d="m374.733,258.111v-120.619c0-5.523-4.477-10-10-10s-10,4.477-10,10v120.618c-12.62,4.2-21.75,16.114-21.75,30.126 0,17.506 14.243,31.749 31.749,31.749s31.749-14.242 31.749-31.749c-5.68434e-14-14.012-9.128-25.925-21.748-30.125zm-10.001,41.874c-6.479,0-11.749-5.271-11.749-11.749 0-6.479 5.271-11.749 11.749-11.749s11.749,5.271 11.749,11.749c-5.68434e-14,6.479-5.27,11.749-11.749,11.749z"></path> </g> </g></svg></li>     
</ol>
<style>
    .welcome-container {
  display: flex;
}
.side {
  height: 100%;
}

.leftSide {
 /* border-right: 1px solid black;*/
  text-align: right;
  width:80%;
  padding-right:5px;
  height:700px;
  position: relative;
  right:57px;
}
.rightSide{
  width: 20%;
  padding-left:5px;
  text-align: center;
  font-style: italic;
  font-size: .9em;
}
#welcome-message{
    text-align: center;
}
div#connectionStatus {
    display: inline;
    position: relative;
    top: -30px;
}
div.connected{
    display:block !important;
    top:0px !important;
}
span.start-msg{
    font-size:1.2em;
    font-weight: bolder;;
}
</style>
<div id="welcome-message">
<span class="start-msg">To start, let's get connected to your network.  </span>
<div class="start-desc">A list of available wi-fi networks will display in the box below.  Choose one and input the password (if needed) when prompted using the on-screen keyboard.  <a href="javascript:window.location.reload()">Refresh this page </a>if the available network window is blank.</div>

<div class="">
    <div class="lds-ripple hidden" id="loader"><div></div><div></div></div>
    <div id="connectionStatus"></div>   
    <button type="button" onclick="location.href='/step2';" id="next-button" class="hidden setup">Continue Setup ></button>

</div>
</div> 

<div class="welcome-container" id="welcome-container">
    <div class="side leftSide">
        <iframe src="/lookingfornetworks" width="1000px" height="700px" id="wifi-iframe" class="hidden" style="border-radius: 15px;"></iframe>
    </div>
    <div class="side rightSide">
        If you have any problems connecting, you can scan the QR code below and continue setting up your Greenscreen wi-fi connection via your personal device. <br/><br/>
        <img src="/img/greenscreen-qrcode.png" width="100px" height="100px">
    </div>
  </div>




</div>
<script>
    let isAPRunningOrAreWeOnline = setInterval(checkIfAPOrGSOnline,5000);
    let intervalCheck = setInterval(checkWIFI,2000);
    let foundAP = false;
    let apLoaded = false;
    async function checkWIFI(){
        const response = await fetch('/wificheck');
         const result = await response.json();
         if(result.isConnected == "1" && window.navigator.onLine){
            clearInterval(intervalCheck);
            document.getElementById("connectionStatus").innerText = "You're connected to WiFi!";
            document.querySelector("div#welcome-message span").classList.add("hidden")
            document.getElementById("connectionStatus").classList.add("connected");
            document.getElementById("wifi-iframe").classList.add("hidden");
            document.getElementById("welcome-container").classList.add("hidden");
            document.getElementById("loader").classList.add("hidden");
            document.getElementById("next-button").classList.remove("hidden");
            document.querySelector(".start-desc").classList.add("hidden")

            clearInterval(intervalCheck);
         }
         else{
            document.getElementById("connectionStatus").innerText = "Waiting for internet connection...";
            document.getElementById("wifi-iframe").classList.remove("hidden");
            document.getElementById("loader").classList.remove("hidden");
            document.querySelector("div#welcome-message span").classList.remove("hidden");
            if(!foundAP)
                checkForBroadcast();

            //show how do I connect?
         }
    }
    function checkIfAPIsLoaded(){
        var img=document.createElement('img');
        img.src='http://localhost:80/img/ledoff.gif?rand='+Math.random();
        img.onload=function(){setAPLoaded(1)};
        img.onerror=function(){setAPLoaded(0)};
        img.style.display='none';
        document.body.appendChild(img);
    }
    function setAPLoaded(status){
        apLoaded = status;
    }
    async function checkForBroadcast(){
        try {
        console.log("Looking for AP...");

        // the await eliminates the need for .then
    
        // this code is resumed once the fetch Promise is resolved.
        // res now has a value.
        //if(res.status=="200"){
            checkIfAPIsLoaded()

        if(apLoaded){
            console.log("Found AP");
            document.getElementById("wifi-iframe").setAttribute("src","http://localhost:80");
            foundAP = true;
        }
        else{
            console.log("Can't find AP")

            document.getElementById("wifi-iframe").setAttribute("src","/lookingfornetworks");
        }
        //console.log("is connected: "+res.isConnected);
       // console.log(res)
        //console.log("Status: ", res.status);
       // console.log("StatusText: ", res.statusText);
        return apLoaded;
    }
    catch(err) { 
        // because the promise could error, it is advised to use
        // try/catch. With a Promise, you would .then(cb).catch(errHandler)
        // but async/await doesn't utilize callbacks.
        console.log(err);
        document.getElementById("wifi-iframe").setAttribute("src","/lookingfornetworks");
        // perform error handling or you can bubble it up.
        throw err
            
        }
}   

    checkWIFI();
    async function checkIfAPOrGSOnline(){
        console.log('doing a double check');
        checkIfAPIsLoaded();
        let wificheck = await fetch('/wificheck');
         let wiFiOnline = await wificheck.json();
         if(wiFiOnline.isConnected == "1"){ 
            console.log('connected to wifi');
            document.getElementById("connectionStatus").innerText = "You're connected to WiFi!";
            document.querySelector("div#welcome-message span").classList.add("hidden")
            document.getElementById("connectionStatus").classList.add("connected");
            document.getElementById("wifi-iframe").classList.add("hidden");
            document.getElementById("welcome-container").classList.add("hidden");
            document.getElementById("loader").classList.add("hidden");
            document.getElementById("next-button").classList.remove("hidden");
            document.querySelector(".start-desc").classList.add("hidden")

         } 
         else if(apLoaded){
            console.log('not connected to wifi');

            if(document.getElementById("wifi-iframe").getAttribute("src").indexOf('localhost')==-1){
             document.getElementById("wifi-iframe").setAttribute("src","http://localhost:80");
             foundAP = true;
             console.log('ap is down');
            }
            else
                console.log('ap is up');
         }
         else{
            //call checkWIFI() to start over
            console.log('not connected to wifi');
            document.getElementById("connectionStatus").innerText = "";
            document.querySelector("div#welcome-message span").classList.remove("hidden")
            document.getElementById("connectionStatus").classList.remove("connected");
            document.getElementById("wifi-iframe").classList.remove("hidden");
            document.getElementById("welcome-container").classList.remove("hidden");
            document.getElementById("loader").classList.remove("hidden");
            document.getElementById("next-button").classList.add("hidden");
            document.querySelector(".start-desc").classList.remove("hidden")

            intervalCheck = setInterval(checkWIFI,2000);
         }


    }
    
	//loadNav();
    //init();
    //loadData();

	</script>
    </body>
</html>