
<title>Weather Settings</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css">
<script src="/js/nav.js"></script>
<script src="/js/util.js"></script>


<body>
	<div class="sidebar" id="sidebar">
	</div>
	<div class="content">

<h2>Weather Settings</h2>
<form action="/weather" method="post" onsubmit="return validateForm()">
    <label class="fieldName">Location</label>
    <div class="formField">
        <div id="savedLocation"></div>
        <input type="text" id="addresslookup" name="addresslookup" placeholder="Type a location..." onkeyup="geoQuery(event)" size="41" onblur="clearLocations()"></input>
        <span id="locationerror">Please add a location before saving</span>
        <button type="button" id="clearLocation" onclick="clearInput()">Clear</button>
        <input type="hidden" id="hiddenLocation" name="hiddenLocation"></input>
        <div id="locationsDiv"></div>
    </div>
    <label class="fieldName">Units</label>
    <div class="formField">
        <div class="container">
            <div class="selector">
                <div class="selector-item">
                    <input type="radio" id="imperial" name="units" class="selector-item_radio" checked onchange="showHideSave()" value="imperial">
                    <label for="imperial" class="selector-item_label">Fahrenheit</label>
                </div>
                <div class="selector-item">
                    <input type="radio" id="metric" name="units" class="selector-item_radio" onchange="showHideSave()" value="metric">
                    <label for="metric" class="selector-item_label">Celsius</label>
                </div>
            </div>
        </div>
    </div>
    <label class="fieldName">Days to Forecast</label>
    <div class="formField">
        <div class="container">
            <div class="selector">
                <div class="selector-item">
                    <input type="radio" id="1day" name="days" class="selector-item_radio" checked onchange="showHideSave()" value="1">
                    <label for="1day" class="selector-item_label">1</label>
                </div>
                <div class="selector-item">
                    <input type="radio" id="2day" name="days" class="selector-item_radio" onchange="showHideSave()" value="2">
                    <label for="2day" class="selector-item_label">2</label>
                </div>
                <div class="selector-item">
                    <input type="radio" id="3day" name="days" class="selector-item_radio" onchange="showHideSave()" value="3">
                    <label for="3day" class="selector-item_label">3</label>
                </div>
                <div class="selector-item">
                    <input type="radio" id="4day" name="days" class="selector-item_radio" onchange="showHideSave()" value="4">
                    <label for="4day" class="selector-item_label">4</label>
                </div>
                <div class="selector-item">
                    <input type="radio" id="5day" name="days" class="selector-item_radio" onchange="showHideSave()" value="5">
                    <label for="5day" class="selector-item_label">5</label>
                </div>
                <div class="selector-item">
                    <input type="radio" id="6day" name="days" class="selector-item_radio" onchange="showHideSave()" value="6">
                    <label for="6day" class="selector-item_label">6</label>
                </div>
                <div class="selector-item">
                    <input type="radio" id="7day" name="days" class="selector-item_radio" onchange="showHideSave()" value="7">
                    <label for="7day" class="selector-item_label">7</label>
                </div>
            </div>
        </div>
    </div>
    <label class="fieldName">Show "Feels Like" Temperature</label>
    <div class="formField">
        <label class="switch">
            <input type="checkbox" id="feelsLike" name="feelsLike" onchange="showHideSave()" value="true">
            <span class="slider round"></span>
        </label>
    </div>
    
    <!-- Show Wind
    <label class="switch">
        <input type="checkbox" checked id="wind" name="wind">
        <span class="slider round"></span>
    </label>-->
    <div class="formField">
        <button type="submit" style="display:none;" id="savebutton">Save Changes to Mirror</button>
    </div>

	</form>
	<div id="status"></div>

	<dialog id="dialogBox">
		<header>
		  <h2 class="header">Confirmation</h2>
		  <button onclick="closeDialog()" id="closeDialogHeader">&#x2716</button>
		</header>
		<section>
		  <p>Are you sure you want to remove this calendar?</p>
		</section>
		<footer>
		  <button onclick="closeDialog()" id="closeDialogFooter">Wait, go back</button>
		  <button onclick="removeCalendarLine()" id="deleteButton">Yes, delete it</button>
		</footer>
	  </dialog>
    </div>
    <span class="qrCode hidden" id="qrParent"><img id="qr-code" src=""><div id="hostnameInfo"></div></span>
<script>
	let showSave = false;
	let saveButton = document.getElementById("savebutton");
    let keypressed = true;
    var _queryInterval = null;
    let minQueryLength = 2;
    let selectedLocation = false;
	
    function validateForm(){
        if(document.getElementById('savedLocationName').innerText.length<1 && document.getElementById('addresslookup').value.length<1){
            document.getElementById('locationerror').style.display='block';
            return false;
        }
        else
            return true;
    }
    function clearLocations(){
        setTimeout(function(){
            if(document.getElementById('savedLocationName').innerText.length>0 && !selectedLocation){
                document.getElementById('locationsDiv').innerHTML = '';
                document.getElementById('addresslookup').value = '';
            }
        },800);
    }
    async function loadData(){
        const response = await fetch("/fetchweatherconfig");
		const myData = await response.json();
        console.log(myData);
        if(myData.friendlyLocation.length>0){
            document.getElementById('savedLocation').innerHTML = `<div id="savedLocation"><div>Current location:</div><span id="savedLocationName">${myData.friendlyLocation}</span></div>`;
        }
        if(myData.units.trim().length>0){
            let units = myData.units;
            radiobtn = document.getElementById(units);
            radiobtn.checked = true;
        }
        if(myData.days.length>0){
            let days = myData.days;
            radiobtn = document.getElementById(days+"day");
            radiobtn.checked = true;
        }
        if(myData.showFeelsLike.length>0){
            let feel = myData.showFeelsLike;
            checkbox = document.getElementById("feelsLike");
            if(feel == "false")
                checkbox.checked = false;
            else
                checkbox.checked = true;
        }
        if(document.getElementById('savedLocationName').innerText.length>2)
            addresslookup.setAttribute("placeholder","Change your saved location...")
		/*
showFeelsLike: 
"false"
        */
    }
    
    function clearInput(){
        document.getElementById('addresslookup').value = '';;
        hideSave();
    }

    function geoQuery(e){
        //wait a second, then loadData based on text
        let timeout = 750;
        let query = document.getElementById('addresslookup').value.trim();
        //do some keystroke checking...ignore some keystrokes
        if(query.length<=minQueryLength){
            clearInterval(_queryInterval);
            hideSave();
        }
        console.log(e.key + " - " + e.code);
        if(e.code != "Space" && e.code != "Period" && e.code != "Comma"){
            console.log('checking to see if I should query...')
            clearInterval(_queryInterval);
            _queryInterval = setInterval(function(){
                console.log("I'm in the setInterval");
                
                if(keypressed && query.length>minQueryLength){
                    keypressed = false;
                    console.log('running query');
                    queryLocation(query).then((res)=>{
                        clearInterval(_queryInterval);
                    });
                }

            },timeout);
        }
    }
	async function queryLocation(query){
		const response = await fetch("/fetchweather?searchterm="+query);
		const myData = await response.json();
		console.log(myData);
        //const parentDatalist = document.getElementById('locations');
        const parentDatalist = document.getElementById('locationsDiv');
        parentDatalist.innerHTML = '';
       // document.getElementById('locations').style.display = "none";
		myData.forEach((element,index) => {
            
            console.log(index+": "+element);
            var dataItem = document.createElement('div');
            dataItem.innerHTML = (element.city?element.city +", ":"") + (element.state?element.state + ", ":"")+ (element.country?element.country:"");
			dataItem.onclick = function(){setLocation(this);}
            dataItem.setAttribute("data-lat",element.latitude);
            dataItem.setAttribute("data-long",element.longitude);
            var dataDesc = document.createElement('span');
            dataDesc.innerHTML = (element.streetName?element.streetName +", ":"")+(element.zipcode?element.zipcode:"");
            dataItem.append(dataDesc)
            parentDatalist.append(dataItem);
           // document.getElementById('locations').style.display = "block";
            keypressed = true; //ready for another query
			//addCalLine(element.internalName,element.ics,element.color)
		});
		
	}
    function setLocation(obj){
        console.log(obj);
        document.getElementById('locationsDiv').innerHTML = '';
        document.getElementById('addresslookup').value = obj.innerHTML.substring(0,obj.innerHTML.indexOf("<span"));
        document.getElementById('hiddenLocation').value = obj.getAttribute("data-lat")+","+obj.getAttribute("data-long");
        showHideSave();
        selectedLocation = true;
    }

	function showHideSave(){
		saveButton.style.display = "";
	}
    function hideSave(){
        saveButton.style.display = "none";
    }
    function timezoneChanged(){
        showHideSave();
    }
</script>

<script>
    loadNav();	
    init();
    loadData();

	</script>
    </body>
</html>
